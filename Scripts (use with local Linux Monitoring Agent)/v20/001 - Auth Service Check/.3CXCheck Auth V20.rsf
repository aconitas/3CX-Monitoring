{"Script":{"MonScriptCategoryI3D":27,"Name":".3CXCheck Auth V20","ScriptKind":0,"ScriptType":3,"Script":"##########################################################################\r\n#\r\n#   aconitas® GmbH · Bäumenheimer Str. 5 · 86690 Mertingen · Germany\r\n#   https://www.aconitas.com · info@aconitas.com · +49 (906) 126725-0\r\n#\r\n#   Version 3CX V20 1.0 · 2024-03-01\r\n#\r\n##########################################################################\r\n\r\n########################################################\r\n#### Exit-Status ungleich Null\r\nset -e\r\n\r\n########################################################\r\n#### Import WebServerPort aus 3CX DB\r\nWEB_SERVER_PORT=$(sudo -u postgres psql -d database_single -c \"SELECT * FROM parameter where name='WEB_ROOT_LOCAL'\" | grep WEB_ROOT_LOCAL | tr -s ' ' | cut -d ' ' -f7)\r\nWEB_SERVER_PORT=${WEB_SERVER_PORT:7} \r\n\r\n########################################################\r\n#### Export WebServerPort in ConfFile auf 3CX Server\r\nif [[ $WEB_SERVER_PORT =~ ':' ]]; then\r\necho $WEB_SERVER_PORT | sed \"s|.*:\\(.*\\)/.*|\\\\1|\" > /tmp/3cx.port\r\nelse\r\necho 80 > /tmp/3cx.port\r\nfi\r\n\r\n########################################################\r\n#### Import WebServerPort in Variable\r\nHTTP_PORT=$(cat /tmp/3cx.port)\r\n\r\n########################################################\r\n#### Authentifizierung an 3CX Web Console\r\nRESULT=$(curl -s -X POST localhost:${HTTP_PORT}/webclient/api/Login/GetAccessToken -H \"Content-Type: application/json\" -d '{\"username\": \"'$Username'\", \"password\": \"'$Password'\"}')\r\n\r\n########################################################\r\n#### Prüfung der Ausgaben für Troubleshooting\r\n#echo $Username\r\n#echo $Password\r\n#echo $HTTP_PORT\r\n#echo $RESULT\r\n\r\necho $RESULT > /tmp/3cx.token\r\nif [[ $RESULT == *AuthSuccess* ]]; then\r\n  echo \"Anmeldung erfolgreich\"\r\n  if [[ $RESULT == *access_token* ]]; then\r\n    RESULT=$(mawk -F'access_token|refresh_token' '{print $2}' /tmp/3cx.token)\r\n    size=${#RESULT}\r\n    RESULT=${RESULT:3:size-6}\r\n    echo $RESULT > /tmp/3cx.token\r\n    #echo \"Token angefordert\"\r\n    exit 0\r\n  else\r\n    rm /tmp/3cx.token\r\n    echo \"Token Anforderung fehlgeschlagen\"\r\n    exit 1\r\n  fi\r\n  exit 0\r\nelse\r\n  echo \"Anmeldung fehlgeschlagen\"\r\n  exit 1\r\nfi","ExitCodeSuccess":0,"ExitCodeWarning":2,"ExitCodeError":1,"IsSelfHeal":false,"SelfHealingScript":null,"SelfHealingExitCodeSuccess":0,"SelfHealingExitCodeError":0,"ThirdPartyIdentifier":null,"ArticleCode":null,"UniqueId":null},"Parameters":[{"ScriptI3D":67,"ParameterName":"$Username","DisplayName":"Username","DefaultValue":null,"IsRequired":true,"ValueType":0},{"ScriptI3D":67,"ParameterName":"$Password","DisplayName":"Password","DefaultValue":null,"IsRequired":true,"ValueType":3}]}